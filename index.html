<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lights</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 24px auto; padding: 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: 14px; }
    .row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .row:last-child { border-bottom: 0; }
    .hint { font-size: 12px; opacity: 0.8; }
    .ok { color: #0a0; }
    .bad { color: #b00; }

    .switch { position: relative; display: inline-block; width: 56px; height: 30px; }
    .switch input { display: none; }
    .slider { position: absolute; cursor: pointer; inset: 0; background: #ccc; border-radius: 30px; transition: 0.15s; }
    .slider:before {
      position: absolute; content: "";
      height: 24px; width: 24px;
      left: 3px; top: 3px;
      background: white; border-radius: 50%;
      transition: 0.15s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }
    input:checked + .slider { background: #4caf50; }
    input:checked + .slider:before { transform: translateX(26px); }
  </style>
</head>
<body>
  <h1>Christmas lights</h1>

  <div class="card">
    Status: <span id="conn" class="bad">disconnected</span>
  </div>
  <div class="card">
    <iframe width="560" height="315"
      src="https://www.youtube.com/embed/x43PSrfMXPo?si=gLMuW1EqfC0n2lWQ"
      title="YouTube video player"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      allowfullscreen></iframe>
  </div>
  
  <div class="card">
    <div class="row">
      <div>
        <strong>Lights 1</strong>
        <div class="hint" id="h1">unknown</div>
      </div>
      <label class="switch">
        <input id="s1" type="checkbox" />
        <span class="slider"></span>
      </label>
    </div>

    <div class="row">
      <div>
        <strong>Lights 2</strong>
        <div class="hint" id="h2">unknown</div>
      </div>
      <label class="switch">
        <input id="s2" type="checkbox" />
        <span class="slider"></span>
      </label>
    </div>

    <div class="row">
      <div>
        <strong>Lights 3</strong>
        <div class="hint" id="h3">unknown</div>
      </div>
      <label class="switch">
        <input id="s3" type="checkbox" />
        <span class="slider"></span>
      </label>
    </div>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const CFG = {
      host: "e70d2ac8d4e84026b8be8dd48456d4c5.s1.eu.hivemq.cloud",
      username: "testtest",
      password: "JP2gmdz2137",
      deviceName: "ZapoLights",
      wsPort: 8884,
      wsPath: "/mqtt"
    };

    let client = null;
    const lastState = { 1: null, 2: null, 3: null };

    function setConn(text, ok) {
      const el = document.getElementById("conn");
      el.textContent = text;
      el.className = ok ? "ok" : "bad";
    }

    function hint(n, txt) { document.getElementById("h" + n).textContent = txt; }
    function tAction(n) { return "netio/" + CFG.deviceName + "/output/" + n + "/action"; }
    function tState(n)  { return "netio/" + CFG.deviceName + "/output/" + n + "/state"; }

    function publishSet(n, on) {
      if (!client || !client.connected) return;
      const payload = on ? "1" : "0";
      client.publish(tAction(n), payload, { qos: 0, retain: false });
      hint(n, "sent");
    }

    function wire(n) {
      const cb = document.getElementById("s" + n);
      cb.addEventListener("change", (e) => publishSet(n, e.target.checked));
    }

    function connect() {
      const url = "wss://" + CFG.host + ":" + CFG.wsPort + CFG.wsPath;
      setConn("connecting", false);

      client = mqtt.connect(url, {
        username: CFG.username,
        password: CFG.password,
        clean: true,
        reconnectPeriod: 1000,
        connectTimeout: 6000
      });

      client.on("connect", () => {
        setConn("connected", true);
        client.subscribe([tState(1), tState(2), tState(3)], { qos: 0 });
      });

      client.on("reconnect", () => setConn("reconnecting", false));
      client.on("close", () => setConn("disconnected", false));
      client.on("error", () => setConn("error", false));

      client.on("message", (topic, payload) => {
        const msg = payload.toString().trim();
        const m = topic.match(/\/output\/(\d+)\/state$/);
        if (!m) return;

        const n = parseInt(m[1], 10);
        const on = (msg === "1" || msg.toLowerCase() === "true" || msg.toLowerCase() === "on");
        lastState[n] = on;

        const cb = document.getElementById("s" + n);
        cb.checked = on;
        hint(n, on ? "on" : "off");
      });
    }

    wire(1); wire(2); wire(3);
    connect();
  </script>
</body>
</html>



